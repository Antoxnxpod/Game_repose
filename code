import pygame

pygame.init()
from random import *

win_width = 800
win_height = 800
tile = 50
FPS: int = 60
win = pygame.display.set_mode((win_width, win_height))
pygame.display.set_caption('Tanks1941')
bulletimg = pygame.transform.scale(pygame.image.load('bullet.png'), (50, 50))
maintank = pygame.transform.scale(pygame.image.load('tankukr.png'), (50, 50))
maintank_right = pygame.transform.rotate(maintank, -90)
maintank_left = pygame.transform.rotate(maintank, 90)
maintank_down = pygame.transform.rotate(maintank, 180)
Enemy_main = pygame.transform.scale(pygame.image.load('enemy.png'), (50, 50))
Enemy_right = pygame.transform.rotate(Enemy_main, -90)
Enemy_left = pygame.transform.rotate(Enemy_main, 90)

clock = pygame.time.Clock()

damage = 5
speed = 1
orange = (225, 80, 15)
gray = (178, 178, 178)
black = (0, 0, 0)


class GameSprite(pygame.sprite.Sprite):
    def __init__(self, player_image, x, y, direction, player_speed, health, damage):
        super().__init__()
        self.image = player_image
        self.rect = self.image.get_rect()
        self.rect.x = x
        self.rect.y = y
        self.speed = player_speed
        self.direction = direction
        self.health = health
        self.damage = damage

    def reset(self):
        win.blit(self.image, (self.rect.x, self.rect.y))


class Player1(GameSprite):
    def update(self):
        selfX, selfY = self.rect.topleft
        keyPressed = pygame.key.get_pressed()
        if keyPressed[pygame.K_d] and self.rect.x < win_width - 50:
            self.rect.x += self.speed
            self.image = maintank_right
            self.direction = 'right'
        if keyPressed[pygame.K_a] and self.rect.x > 0:
            self.rect.x -= self.speed
            self.image = maintank_left
            self.direction = 'left'
        if keyPressed[pygame.K_s] and self.rect.y < win_height - 50:
            self.rect.y += self.speed
            self.image = maintank_down
            self.direction = 'down'
        if keyPressed[pygame.K_w] and self.rect.y > 0:
            self.rect.y -= self.speed
            self.image = maintank
            self.direction = 'up'
        for obj in objects:
            if self.rect.colliderect(obj.rect):
                self.rect.topleft = selfX, selfY
    
    def shot(self):
        if self.direction == 'right':
            p = Bullet(self.rect.x+15, self.rect.y+20, 3, 1, 5, 0)
        elif self.direction == 'left':
            p = Bullet(self.rect.x+15, self.rect.y + 20, 3, 1, -5, 0)
        elif self.direction == 'up':
            p = Bullet(self.rect.x+15, self.rect.y + 20, 3, 1, 0, -5)
        else:
            p = Bullet(self.rect.x+15, self.rect.y + 20, 3, 1, 0, 5)

a = randint(0, 10)
class Enemy(GameSprite):
    def shot(self, ):
        if a == 4:
            self.direction = 'right'
            self.image = Enemy_right
            p = Bullet(self.rect.x+15, self.rect.y+20, 3, 1, 5, 0)
            #print('bullet from bot has been arrived', bullets)
        if a == 7:
            self.direction = 'left'
            self.image = Enemy_left
            p = Bullet(self.rect.x + 15, self.rect.y + 20, 3, 1, -5, 0)
            #print('bullet from bot has been arrived', bullets)



class Square(pygame.sprite.Sprite):
    def __init__(self, width, height, color1, color2, color3, health, y, x):
        super().__init__()
        self.color1 = color1
        self.color2 = color2
        self.color3 = color3
        self.width = width
        self.height = height
        self.image = pygame.Surface((width, height))
        self.image.fill((color1, color2, color3))
        self.rect = self.image.get_rect()
        self.rect.y = y
        self.rect.x = x
        self.health = health

    def refresh(self):
        win.blit(self.image, (self.rect.x, self.rect.y))


class Block():
    def __init__(self, px, py, size, hp):
        objects.append(self)
        self.rect = pygame.Rect(px, py,size, size)
        self.hp = hp

    def update(self):
        pass

    def draw(self):
        pygame.draw.rect(win, orange, self.rect)
        pygame.draw.rect(win, gray, self.rect, 2)

class Bullet():
    def __init__(self, x, y,size, damage, dx, dy):
        bullets.append(self)
        self.damage = damage
        self.dx = dx
        self.dy = dy
        self.rect = pygame.Rect(x, y, size, size)

    def update(self):
        self.rect.x += self.dx
        self.rect.y += self.dy
        if self.rect.x > win_width or self.rect.y>win_height:
            bullets.remove(self)
            #print('Bullet has been removed')
        elif self.rect.x == -1:
            bullets.remove(self)
            #print('Bullet has been removed')
        elif self.rect.y<-30:
            bullets.remove(self)
            #print('Bullet has been removed')

    def draw(self):
        pygame.draw.circle(win, gray, (self.rect.x, self.rect.y), 2)
    
    def collide_list(self,objects, enemies):
        for obj in objects:
            if self.rect.colliderect(obj.rect):
                obj.hp -= self.damage
                bullets.remove(self)
                if obj.hp <= 0:
                    objects.remove(obj)
            if self.rect.colliderect(Enemy_create.rect):
                Enemy_create.hp -= self.damage
                bullets.remove(self)
                if Enemy_create.hp <= 0:
                    enemies.remove(Enemy_create)


Enemy_create = Enemy(maintank, 600, 600, 'up', speed, 10, damage)
Enemy_create2 = Enemy(maintank, 600, 600, 'up', speed, 10, damage)
Enemy_create3 = Enemy(maintank, 600, 600, 'up', speed, 10, damage)
maintank_create = Player1(maintank, 10, 0, 'up', speed, 10, damage)
objects = []
bullets = []
enemies = [Enemy_create, Enemy_create2, Enemy_create3]
for _ in range(50):
    while True:
        x = randint(0, win_width // tile - 1) * tile
        y = randint(0, win_height // tile - 1) * tile
        rect = pygame.Rect(x, y, tile, tile)
        fined = False
        for obj in objects:
            if rect.colliderect(obj.rect):
                fined = True
            elif rect.colliderect(maintank_create.rect):
                fined = True
        if not fined:
            break
    Block(x, y, tile, 1)

game = True
while game:
    win.fill(black)
    for obj in objects:
        obj.draw()
    for bullet in bullets:
        bullet.update()
        bullet.draw()
        bullet.collide_list(objects, enemies)
    Enemy_create.reset()
    Enemy_create.shot()
    
    a = randint(0, 200)

    maintank_create.reset()
    maintank_create.update()
    for e in pygame.event.get():
        if e.type == pygame.KEYDOWN:
            if e.key == pygame.K_SPACE:
                maintank_create.shot()
                #print('Bullet has been arrived:', bullets)
        if e.type == pygame.QUIT:
            game = False
    clock.tick(FPS)
    pygame.display.update()
